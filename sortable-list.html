<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../Sortable/Sortable.html">
<!--
`sortable-list`
Simple, flexible drag-and-drop sortable lists utilizing the excellent
[Sortable.js](http://rubaxa.github.io/Sortable/) library under the covers.

##### Example

    <sortable-list content="{{content}}" output="{{output}}">
    </sortable-list>

@demo demo/index.html
-->
<dom-module id="sortable-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <sortable-js id="sortable" on-end="onSort">
      <content></content>
    </sortable-js>
  </template>
  <script>
    Array.prototype.move = function (old_index, new_index) {
      if (new_index >= this.length) {
        var k = new_index - this.length
        while ((k--) + 1) {
          this.push(undefined)
        }
      }
      this.splice(new_index, 0, this.splice(old_index, 1)[0])
    }
    var testing = {}
    var testingSortMe = {}
    Polymer({
      is: 'sortable-list',
      properties: {
        output: {type: Array, notify: true, computed: "getOutput(sortMe)"}
      },
      getOutput: function (sortMe){
        this.debounce("onStart", this.onStart, 120)
        return sortMe
      },
      onStart: function () {
        if (this.$.sortable.sortable){
          this.startArray = this.$.sortable.sortable.toArray()
          testing = {}
          if (Array.isArray(this.sortMe) && this.sortMe.length) {
            for (i = 0; i < this.startArray.length; i++) { 
              testing[this.startArray[i]] = this.sortMe[i]
            }
          } 
        }
      },
      onSort: function (evt) {
        if (testing && !(evt.oldIndex + evt.newIndex)) {
          this.endArray = this.$.sortable.sortable.toArray()
          var sortMe = []
          for (i = 0; i < this.endArray.length; i++) { 
            sortMe.push(testing[this.endArray[i]])
          }
        } else {
          testing.move(evt.oldIndex, evt.newIndex)
        }
        this.set("sortMe", sortMe)
      }
    })
  function clone(obj) {
    var copy;
    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;
    // Handle Date
    if (obj instanceof Date) {
      copy = new Date();
      copy.setTime(obj.getTime());
      return copy;
    }
    // Handle Array
    if (obj instanceof Array) {
      copy = [];
      for (var i = 0, len = obj.length; i < len; i++) {
        copy[i] = clone(obj[i]);
      }
      return copy;
    }
    // Handle Object
    if (obj instanceof Object) {
      copy = {};
      for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
      }
      return copy;
    }
    throw new Error("Unable to copy obj! Its type isn't supported.");
  }
  </script>
</dom-module>
